{% extends "base.html" %}

{% block head %}
<style>
    /* Professional Dashboard Styles */
    .command-center {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    @media (min-width: 1280px) {
        .command-center {
            grid-template-columns: repeat(5, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Professional Trading Dashboard -->
<div class="space-y-4">
    <!-- Dashboard Header with Status -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pb-4 border-b border-base-300">
        <div>
            <h1 class="text-2xl font-bold text-base-content">Trading Command Center</h1>
            <p class="text-sm text-base-content/60 mt-1">Real-time account overview and market positions</p>
        </div>

        <!-- Master Contract Status (Professional Style) -->
        <div class="inline-flex items-center gap-3 px-4 py-2 bg-base-200 rounded-lg border border-base-300">
            <span class="text-xs font-medium uppercase tracking-wider text-base-content/60">Contract Status</span>
            <div class="flex items-center gap-2">
                <div id="master-contract-led" class="w-2 h-2 rounded-full bg-gray-400 animate-pulse"></div>
                <span id="master-contract-status-text" class="text-sm font-medium">Checking...</span>
            </div>
        </div>
    </div>

    <!-- Professional Metrics Grid -->
    <div class="command-center">
        <!-- Available Balance -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Available Cash</span>
                <svg class="w-4 h-4 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
            </div>
            <div class="metric-value">
                <span class="text-xs">₹</span>
                <span class="font-mono">{{ margin_data.get('availablecash', '0.00') }}</span>
            </div>
            <div class="metric-change">
                <span class="badge-pro badge-info">CASH</span>
            </div>
        </div>

        <!-- Collateral -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Collateral</span>
                <svg class="w-4 h-4 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
            </div>
            <div class="metric-value">
                <span class="text-xs">₹</span>
                <span class="font-mono">{{ margin_data.get('collateral', '0.00') }}</span>
            </div>
            <div class="metric-change">
                <span class="badge-pro badge-info">PLEDGED</span>
            </div>
        </div>

        <!-- Unrealized P&L -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Unrealized P&L</span>
                <svg class="w-4 h-4 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
            </div>
            <div class="metric-value {% if margin_data.get('m2munrealized', '0.00')|float > 0 %}positive{% elif margin_data.get('m2munrealized', '0.00')|float < 0 %}negative{% endif %}">
                <span class="text-xs">₹</span>
                <span class="font-mono">{{ margin_data.get('m2munrealized', '0.00') }}</span>
            </div>
            <div class="metric-change">
                {% set unrealized = margin_data.get('m2munrealized', '0.00')|float %}
                {% if unrealized > 0 %}
                    <span class="change-value positive">+{{ "{:.2f}".format(unrealized) }}</span>
                    <span class="badge-pro badge-success">PROFIT</span>
                {% elif unrealized < 0 %}
                    <span class="change-value negative">{{ "{:.2f}".format(unrealized) }}</span>
                    <span class="badge-pro badge-error">LOSS</span>
                {% else %}
                    <span class="change-value">0.00</span>
                    <span class="badge-pro">FLAT</span>
                {% endif %}
            </div>
        </div>

        <!-- Realized P&L -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Realized P&L</span>
                <svg class="w-4 h-4 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="metric-value {% if margin_data.get('m2mrealized', '0.00')|float > 0 %}positive{% elif margin_data.get('m2mrealized', '0.00')|float < 0 %}negative{% endif %}">
                <span class="text-xs">₹</span>
                <span class="font-mono">{{ margin_data.get('m2mrealized', '0.00') }}</span>
            </div>
            <div class="metric-change">
                {% set realized = margin_data.get('m2mrealized', '0.00')|float %}
                {% if realized > 0 %}
                    <span class="change-value positive">+{{ "{:.2f}".format(realized) }}</span>
                    <span class="badge-pro badge-success">BOOKED</span>
                {% elif realized < 0 %}
                    <span class="change-value negative">{{ "{:.2f}".format(realized) }}</span>
                    <span class="badge-pro badge-error">BOOKED</span>
                {% else %}
                    <span class="change-value">0.00</span>
                    <span class="badge-pro">NO TRADES</span>
                {% endif %}
            </div>
        </div>

        <!-- Utilized Margin -->
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Margin Used</span>
                <svg class="w-4 h-4 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="metric-value">
                <span class="text-xs">₹</span>
                <span class="font-mono">{{ margin_data.get('utiliseddebits', '0.00') }}</span>
            </div>
            <div class="metric-change">
                {% set total_margin = margin_data.get('availablecash', '0')|float + margin_data.get('collateral', '0')|float %}
                {% set used_margin = margin_data.get('utiliseddebits', '0')|float %}
                {% if total_margin > 0 %}
                    {% set utilization = (used_margin / total_margin * 100) %}
                    <span class="text-xs font-medium">{{ "{:.1f}".format(utilization) }}% utilized</span>
                {% else %}
                    <span class="badge-pro">NO MARGIN</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Actions Section (Professional Style) -->
    <div class="mt-8">
        <h2 class="text-lg font-semibold text-base-content mb-4">Quick Actions</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Place Order -->
            <a href="{{ url_for('search_bp.token') }}" class="group">
                <div class="flex items-center gap-4 p-4 bg-base-100 border border-base-300 rounded-lg hover:border-primary hover:bg-primary/5 transition-all">
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-primary/10 text-primary group-hover:bg-primary group-hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-base-content">Place Order</h3>
                        <p class="text-xs text-base-content/60">Search & trade symbols</p>
                    </div>
                </div>
            </a>

            <!-- View Positions -->
            <a href="{{ url_for('orders_bp.positions') }}" class="group">
                <div class="flex items-center gap-4 p-4 bg-base-100 border border-base-300 rounded-lg hover:border-primary hover:bg-primary/5 transition-all">
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-success/10 text-success group-hover:bg-success group-hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-base-content">Positions</h3>
                        <p class="text-xs text-base-content/60">View open positions</p>
                    </div>
                </div>
            </a>

            <!-- View Logs -->
            <a href="{{ url_for('log_bp.view_logs') }}" class="group">
                <div class="flex items-center gap-4 p-4 bg-base-100 border border-base-300 rounded-lg hover:border-primary hover:bg-primary/5 transition-all">
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-warning/10 text-warning group-hover:bg-warning group-hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-base-content">System Logs</h3>
                        <p class="text-xs text-base-content/60">Monitor activity</p>
                    </div>
                </div>
            </a>

            <!-- Documentation -->
            <a href="https://docs.openalgo.in" target="_blank" rel="noopener noreferrer" class="group">
                <div class="flex items-center gap-4 p-4 bg-base-100 border border-base-300 rounded-lg hover:border-primary hover:bg-primary/5 transition-all">
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-info/10 text-info group-hover:bg-info group-hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-base-content">Documentation</h3>
                        <p class="text-xs text-base-content/60">API & guides</p>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Market Overview Section (New Addition) -->
    <div class="mt-8">
        <h2 class="text-lg font-semibold text-base-content mb-4">Market Overview</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Recent Orders Summary -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4">
                <h3 class="font-medium text-base-content mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    Recent Activity
                </h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between py-2 border-b border-base-200">
                        <span class="text-sm text-base-content/60">Today's Orders</span>
                        <span class="text-sm font-medium">0</span>
                    </div>
                    <div class="flex items-center justify-between py-2 border-b border-base-200">
                        <span class="text-sm text-base-content/60">Open Positions</span>
                        <span class="text-sm font-medium">0</span>
                    </div>
                    <div class="flex items-center justify-between py-2">
                        <span class="text-sm text-base-content/60">Active Strategies</span>
                        <span class="text-sm font-medium">0</span>
                    </div>
                </div>
            </div>

            <!-- Account Summary -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4">
                <h3 class="font-medium text-base-content mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Account Summary
                </h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between py-2 border-b border-base-200">
                        <span class="text-sm text-base-content/60">Account Type</span>
                        <span class="text-sm font-medium">{{ session.get('broker', 'N/A') }}</span>
                    </div>
                    <div class="flex items-center justify-between py-2 border-b border-base-200">
                        <span class="text-sm text-base-content/60">User ID</span>
                        <span class="text-sm font-medium">{{ session.get('user', 'N/A') }}</span>
                    </div>
                    <div class="flex items-center justify-between py-2">
                        <span class="text-sm text-base-content/60">Session Status</span>
                        <span class="badge badge-success badge-sm">Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Master Contract Status Controller (Preserved) -->
<script>
// Master Contract Status LED Controller
class MasterContractStatus {
    constructor() {
        this.led = document.getElementById('master-contract-led');
        this.statusText = document.getElementById('master-contract-status-text');
        this.checkInterval = null;
        this.init();
    }

    init() {
        // Check status immediately
        this.checkStatus();

        // Set up periodic checking every 5 seconds
        this.checkInterval = setInterval(() => this.checkStatus(), 5000);

        // Listen for WebSocket events
        if (typeof socket !== 'undefined') {
            socket.on('master_contract_download', (data) => {
                this.handleWebSocketUpdate(data);
            });
        }
    }

    async checkStatus() {
        try {
            const response = await fetch('/api/master-contract/status');
            const data = await response.json();
            this.updateDisplay(data);
        } catch (error) {
            console.error('Error checking master contract status:', error);
            this.updateDisplay({ status: 'error', message: 'Failed to check status' });
        }
    }

    handleWebSocketUpdate(data) {
        // WebSocket update received, fetch fresh status
        this.checkStatus();
    }

    updateDisplay(data) {
        const { status, message, total_symbols } = data;

        // Remove all animation classes first
        this.led.classList.remove('animate-pulse', 'animate-spin');

        switch (status) {
            case 'success':
                this.led.className = 'w-2 h-2 rounded-full bg-success';
                this.statusText.textContent = total_symbols ? `${total_symbols} symbols` : 'Ready';
                this.statusText.className = 'text-sm font-medium text-success';
                // Clear interval once successful
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                    this.checkInterval = null;
                }
                break;

            case 'downloading':
                this.led.className = 'w-2 h-2 rounded-full bg-warning animate-pulse';
                this.statusText.textContent = 'Syncing...';
                this.statusText.className = 'text-sm font-medium text-warning';
                break;

            case 'error':
                this.led.className = 'w-2 h-2 rounded-full bg-error';
                this.statusText.textContent = 'Error';
                this.statusText.className = 'text-sm font-medium text-error';
                // Show detailed error in tooltip
                this.statusText.title = message || 'Download failed';
                break;

            case 'pending':
                this.led.className = 'w-2 h-2 rounded-full bg-base-content/40 animate-pulse';
                this.statusText.textContent = 'Pending';
                this.statusText.className = 'text-sm font-medium text-base-content/60';
                break;

            default:
                this.led.className = 'w-2 h-2 rounded-full bg-base-content/40';
                this.statusText.textContent = 'Unknown';
                this.statusText.className = 'text-sm font-medium text-base-content/60';
        }
    }

    destroy() {
        if (this.checkInterval) {
            clearInterval(this.checkInterval);
        }
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.masterContractStatus = new MasterContractStatus();

    // Add number animation effect
    const animateValue = (element, start, end, duration) => {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            element.textContent = (progress * (end - start) + start).toFixed(2);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    };

    // Animate metric values on load
    document.querySelectorAll('.metric-value .font-mono').forEach(el => {
        const value = parseFloat(el.textContent.replace(/,/g, ''));
        if (!isNaN(value) && value !== 0) {
            el.textContent = '0.00';
            animateValue(el, 0, value, 600);
        }
    });
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (window.masterContractStatus) {
        window.masterContractStatus.destroy();
    }
});
</script>
{% endblock %}